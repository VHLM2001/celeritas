<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geant4 integration &mdash; Celeritas v0.2.0-22+59d3b167 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="References" href="../references.html" />
    <link rel="prev" title="Minimal Geant4 integration" href="geant4-minimal.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Celeritas
            <img src="../_static/celeritas-thumbnail.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.2.1-dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="minimal.html">Minimal Celeritas usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="geant4-minimal.html">Minimal Geant4 integration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Geant4 integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#main-executable">Main executable</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-initialization">User initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-actions">User actions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sensitive-detectors">Sensitive Detectors</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../acknowledgments.html">Acknowledgments</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../appendices/release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/development.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/administration.html">Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendices/license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Celeritas</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../examples.html">Examples</a> &raquo;</li>
      <li>Geant4 integration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/geant4-full.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="geant4-integration">
<span id="example-geant-full"></span><h1>Geant4 integration<a class="headerlink" href="#geant4-integration" title="Permalink to this heading"></a></h1>
<p>This lengthy example is a generic demonstration of using Celeritas to offload
EM tracks from a Geant4 application. It is compatible with Geant4 10.7–11.0.
See <a class="reference internal" href="../api/accel.html#accel"><span class="std std-ref">Acceleritas</span></a> for API documentation of the Celeritas classes being called.</p>
<section id="main-executable">
<h2>Main executable<a class="headerlink" href="#main-executable" title="Permalink to this heading"></a></h2>
<p>The main method creates the action initialization and reads user setup options
through a macro file. The setup options, aside from the detector geometry file
and event input file, map to options in the <code class="xref py py-class docutils literal notranslate"><span class="pre">celeritas::SetupOptions</span></code>
class.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdlib&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;CLHEP/Random/Random.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4RunManager.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4UImanager.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;celeritas/ext/GeantConfig.hh&quot;</span><span class="cp"></span>
<span class="cp">#if !CELERITAS_G4_V10</span>
<span class="cp">#</span><span class="w">    </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&lt;G4RunManagerFactory.hh&gt;</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#</span><span class="w">    </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&lt;G4MTRunManager.hh&gt;</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;FTFP_BERT.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/Assert.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/Macros.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/io/Logger.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/sys/TypeDemangler.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/ExceptionConverter.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/Logger.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ActionInitialization.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DetectorConstruction.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GlobalSetup.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;PrimaryGeneratorAction.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">macro_filename</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Set the random seed *before* the run manager is instantiated</span>
<span class="w">    </span><span class="c1">// (G4MTRunManager constructor uses the RNG)</span>
<span class="w">    </span><span class="n">CLHEP</span><span class="o">::</span><span class="n">HepRandom</span><span class="o">::</span><span class="n">setTheSeed</span><span class="p">(</span><span class="mh">0xcf39c1fa9a6e29bcul</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">G4RunManager</span><span class="o">&gt;</span><span class="w"> </span><span class="n">run_manager</span><span class="p">;</span><span class="w"></span>
<span class="cp">#if CELERITAS_G4_V10</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CELERITAS_G4_MT</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">run_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">G4MTRunManager</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">run_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">G4RunManager</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="cp">#else</span>
<span class="w">    </span><span class="n">run_manager</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">G4RunManagerFactory</span><span class="o">::</span><span class="n">CreateRunManager</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">CELERITAS_G4_MT</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">G4RunManagerType</span><span class="o">::</span><span class="n">MT</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">G4RunManagerType</span><span class="o">::</span><span class="n">Serial</span><span class="p">));</span><span class="w"></span>
<span class="cp">#endif</span>
<span class="w">    </span><span class="n">CELER_ASSERT</span><span class="p">(</span><span class="n">run_manager</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">celeritas</span><span class="o">::</span><span class="n">self_logger</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">celeritas</span><span class="o">::</span><span class="n">make_mt_logger</span><span class="p">(</span><span class="o">*</span><span class="n">run_manager</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_LOG</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Run manager type: &quot;</span><span class="w"></span>
<span class="w">                    </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">celeritas</span><span class="o">::</span><span class="n">TypeDemangler</span><span class="o">&lt;</span><span class="n">G4RunManager</span><span class="o">&gt;</span><span class="p">{}(</span><span class="o">*</span><span class="n">run_manager</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Construct geometry, SD factory, physics, actions</span>
<span class="w">    </span><span class="n">run_manager</span><span class="o">-&gt;</span><span class="n">SetUserInitialization</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">demo_geant</span><span class="o">::</span><span class="n">DetectorConstruction</span><span class="p">{});</span><span class="w"></span>
<span class="w">    </span><span class="n">run_manager</span><span class="o">-&gt;</span><span class="n">SetUserInitialization</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">FTFP_BERT</span><span class="p">{</span><span class="cm">/* verbosity = */</span><span class="w"> </span><span class="mi">0</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">run_manager</span><span class="o">-&gt;</span><span class="n">SetUserInitialization</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">demo_geant</span><span class="o">::</span><span class="n">ActionInitialization</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="n">demo_geant</span><span class="o">::</span><span class="n">GlobalSetup</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetIgnoreProcesses</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="s">&quot;CoulombScat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;muIoni&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;muBrems&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;muPairProd&quot;</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="n">G4UImanager</span><span class="o">*</span><span class="w"> </span><span class="n">ui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G4UImanager</span><span class="o">::</span><span class="n">GetUIpointer</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_ASSERT</span><span class="p">(</span><span class="n">ui</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_LOG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Executing macro commands from &#39;&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">macro_filename</span><span class="w"></span>
<span class="w">                      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;&#39;&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">ui</span><span class="o">-&gt;</span><span class="n">ApplyCommand</span><span class="p">(</span><span class="s">&quot;/control/execute &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">macro_filename</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Initialize run and process events</span>
<span class="w">    </span><span class="n">run_manager</span><span class="o">-&gt;</span><span class="n">Initialize</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Load the input file</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">num_events</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_TRY_HANDLE</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">num_events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">demo_geant</span><span class="o">::</span><span class="n">PrimaryGeneratorAction</span><span class="o">::</span><span class="n">NumEvents</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">celeritas</span><span class="o">::</span><span class="n">ExceptionConverter</span><span class="p">{</span><span class="s">&quot;demo-geant000&quot;</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="n">run_manager</span><span class="o">-&gt;</span><span class="n">BeamOn</span><span class="p">(</span><span class="n">num_events</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace</span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Execute and run.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">argc</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;--help&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;-h&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;usage: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; {commands}.mac</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Environment variables:</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;  G4FORCE_RUN_MANAGER_TYPE: MT or Serial</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;  G4FORCENUMBEROFTHREADS: set CPU worker thread count</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;  CELER_DISABLE_DEVICE: nonempty disables CUDA</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;  CELER_LOG: global logging level</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;  CELER_LOG_LOCAL: thread-local logging level</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"></span>
<span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Run with threads and macro filename</span>
<span class="w">    </span><span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="n">CELER_LOG</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Run completed successfully; exiting&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;type_traits&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/SetupOptions.hh&quot;</span><span class="cp"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">G4GenericMessenger</span><span class="p">;</span><span class="w"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Global configuration for setting from the UI under &quot;/config&quot;.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">GlobalSetup</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@{</span>
<span class="w">    </span><span class="c1">//! \name Type aliases</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SetupOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">celeritas</span><span class="o">::</span><span class="n">SetupOptions</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@}</span>

<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Return non-owning pointer to a singleton</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">GlobalSetup</span><span class="o">*</span><span class="w"> </span><span class="n">Instance</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">//!@{</span>
<span class="w">    </span><span class="c1">//! Demo setup options</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetGeometryFile</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">geometry_file_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetEventFile</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">event_file_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@}</span>

<span class="w">    </span><span class="c1">//! Get a mutable reference to the setup options for DetectorConstruction</span>
<span class="w">    </span><span class="n">celeritas</span><span class="o">::</span><span class="n">SDSetupOptions</span><span class="o">&amp;</span><span class="w"> </span><span class="n">GetSDSetupOptions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">options_</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">//! Get an immutable reference to the setup options</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">SetupOptions</span><span class="w"> </span><span class="k">const</span><span class="o">&gt;</span><span class="w"> </span><span class="n">GetSetupOptions</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">options_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Set the along-step factory function/instance</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">SetAlongStep</span><span class="p">(</span><span class="n">SetupOptions</span><span class="o">::</span><span class="n">AlongStepFactory</span><span class="w"> </span><span class="n">asf</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Set the list of ignored EM process names</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">SetIgnoreProcesses</span><span class="p">(</span><span class="n">SetupOptions</span><span class="o">::</span><span class="n">VecString</span><span class="w"> </span><span class="n">ignored</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Private constructor since we&#39;re a singleton</span>
<span class="w">    </span><span class="n">GlobalSetup</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="o">~</span><span class="n">GlobalSetup</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Data</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">celeritas</span><span class="o">::</span><span class="n">SetupOptions</span><span class="o">&gt;</span><span class="w"> </span><span class="n">options_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">geometry_file_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">event_file_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">G4GenericMessenger</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messenger_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
</section>
<section id="user-initialization">
<h2>User initialization<a class="headerlink" href="#user-initialization" title="Permalink to this heading"></a></h2>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;utility&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4VUserDetectorConstruction.hh&gt;</span><span class="cp"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">G4LogicalVolume</span><span class="p">;</span><span class="w"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Construct a detector from a GDML filename set in GlobalSetup.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">DetectorConstruction</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">G4VUserDetectorConstruction</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Set up global celeritas SD options during construction</span>
<span class="w">    </span><span class="n">DetectorConstruction</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">G4VPhysicalVolume</span><span class="o">*</span><span class="w"> </span><span class="nf">Construct</span><span class="p">()</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">ConstructSDandField</span><span class="p">()</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">G4VPhysicalVolume</span><span class="o">&gt;</span><span class="w"> </span><span class="n">world_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">G4LogicalVolume</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">detectors_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;DetectorConstruction.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;map&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4Exception.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4GDMLAuxStructType.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4GDMLParser.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4LogicalVolume.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4SDManager.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4VPhysicalVolume.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/io/Logger.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/SetupOptions.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GlobalSetup.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SensitiveDetector.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Set up Celeritas SD options during construction.</span>
<span class="cm"> *</span>
<span class="cm"> * This should be done only during the main/serial thread.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="n">DetectorConstruction</span><span class="o">::</span><span class="n">DetectorConstruction</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">demo_geant</span><span class="o">::</span><span class="n">GlobalSetup</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSDSetupOptions</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Use Celeritas &quot;hit processor&quot; to call back to Geant4 SDs.</span>
<span class="w">    </span><span class="n">sd</span><span class="p">.</span><span class="n">enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Only call back for nonzero energy depositions: this is currently a</span>
<span class="w">    </span><span class="c1">// global option for all detectors, so if any SDs extract data from tracks</span>
<span class="w">    </span><span class="c1">// with no local energy deposition over the step, it must be set to false.</span>
<span class="w">    </span><span class="n">sd</span><span class="p">.</span><span class="n">ignore_zero_deposition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Using the pre-step point, reconstruct the G4 touchable handle.</span>
<span class="w">    </span><span class="n">sd</span><span class="p">.</span><span class="n">locate_touchable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Since at least one SD uses the pre-step time, export it from Celeritas.</span>
<span class="w">    </span><span class="n">sd</span><span class="p">.</span><span class="n">pre</span><span class="p">.</span><span class="n">global_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Load geometry and sensitive detector volumes.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="n">G4VPhysicalVolume</span><span class="o">*</span><span class="w"> </span><span class="n">DetectorConstruction</span><span class="o">::</span><span class="n">Construct</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_LOG_LOCAL</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Loading detector geometry&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">G4GDMLParser</span><span class="w"> </span><span class="n">gdml_parser</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">gdml_parser</span><span class="p">.</span><span class="n">SetStripFlag</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GlobalSetup</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetGeometryFile</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">G4Exception</span><span class="p">(</span><span class="s">&quot;DetectorConstruction::Construct()&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="n">FatalException</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="s">&quot;No GDML file was specified with setGeometryFile&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">validate_gdml_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">gdml_parser</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">validate_gdml_schema</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Find sensitive detectors</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lv_vecaux</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">gdml_parser</span><span class="p">.</span><span class="n">GetAuxMap</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">G4GDMLAuxStructType</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">aux</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">lv_vecaux</span><span class="p">.</span><span class="n">second</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aux</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;SensDet&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">detectors_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">lv_vecaux</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">aux</span><span class="p">.</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Claim ownership of world volume and pass it to the caller</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">gdml_parser</span><span class="p">.</span><span class="n">GetWorldVolume</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="kt">void</span><span class="w"> </span><span class="n">DetectorConstruction</span><span class="o">::</span><span class="n">ConstructSDandField</span><span class="p">()</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_LOG_LOCAL</span><span class="p">(</span><span class="n">debug</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Loading sensitive detectors&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">G4SDManager</span><span class="o">*</span><span class="w"> </span><span class="n">sd_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G4SDManager</span><span class="o">::</span><span class="n">GetSDMpointer</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lv_name</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">detectors_</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">detector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">SensitiveDetector</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lv_name</span><span class="p">.</span><span class="n">second</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">lv_name</span><span class="p">.</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">SetSensitiveDetector</span><span class="p">(</span><span class="n">detector</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">sd_manager</span><span class="o">-&gt;</span><span class="n">AddNewDetector</span><span class="p">(</span><span class="n">detector</span><span class="p">.</span><span class="n">release</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4VUserActionInitialization.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/SharedParams.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Set up demo-specific action initializations.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">ActionInitialization</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">G4VUserActionInitialization</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@{</span>
<span class="w">    </span><span class="c1">//! \name Type aliases</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SPParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">celeritas</span><span class="o">::</span><span class="n">SharedParams</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@}</span>

<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">ActionInitialization</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">BuildForMaster</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">Build</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">SPParams</span><span class="w"> </span><span class="n">params_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">mutable</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">init_celeritas_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;ActionInitialization.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/io/Logger.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/LocalTransporter.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;EventAction.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GlobalSetup.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;PrimaryGeneratorAction.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;RunAction.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;TrackingAction.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Construct global data to be shared across Celeritas workers.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="n">ActionInitialization</span><span class="o">::</span><span class="n">ActionInitialization</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">init_celeritas_</span><span class="p">{</span><span class="nb">true</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Create params to be shared across worker threads</span>
<span class="w">    </span><span class="n">params_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">celeritas</span><span class="o">::</span><span class="n">SharedParams</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Make global setup commands available to UI</span>
<span class="w">    </span><span class="n">GlobalSetup</span><span class="o">::</span><span class="n">Instance</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Construct actions on the master thread.</span>
<span class="cm"> *</span>
<span class="cm"> * Since our \c RunAction::EndOfRunAction only calls \c SharedParams::Finalize</span>
<span class="cm"> * on the master thread, we need a special case for MT mode.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">ActionInitialization</span><span class="o">::</span><span class="n">BuildForMaster</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_LOG_LOCAL</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Constructing user action on master thread&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Run action for &#39;master&#39; has no track states and is responsible for</span>
<span class="w">    </span><span class="c1">// setting up celeritas</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">SetUserAction</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">RunAction</span><span class="p">{</span><span class="n">GlobalSetup</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSetupOptions</span><span class="p">(),</span><span class="w"></span>
<span class="w">                      </span><span class="n">params_</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="k">nullptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">init_celeritas_</span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Subsequent worker threads must not set up celeritas</span>
<span class="w">    </span><span class="n">init_celeritas_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Construct actions on each worker thread.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">ActionInitialization</span><span class="o">::</span><span class="n">Build</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_LOG_LOCAL</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Constructing user actions on worker threads&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Primary generator emits source particles</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">SetUserAction</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PrimaryGeneratorAction</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Create thread-local transporter to share between actions</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">transport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">celeritas</span><span class="o">::</span><span class="n">LocalTransporter</span><span class="o">&gt;</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Run action sets up Celeritas (init_celeritas_ will be true iff</span>
<span class="w">    </span><span class="c1">// using a serial run manager)</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">SetUserAction</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">RunAction</span><span class="p">{</span><span class="n">GlobalSetup</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetSetupOptions</span><span class="p">(),</span><span class="w"></span>
<span class="w">                      </span><span class="n">params_</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">transport</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">init_celeritas_</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Event action saves event ID for offloading and runs queued particles at</span>
<span class="w">    </span><span class="c1">// end of event</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">SetUserAction</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">EventAction</span><span class="p">{</span><span class="n">transport</span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Tracking action offloads tracks to device and kills them</span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">SetUserAction</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TrackingAction</span><span class="p">{</span><span class="n">params_</span><span class="p">,</span><span class="w"> </span><span class="n">transport</span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/AlongStepFactory.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Construct an along-step action with MSC but no field.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">NoFieldAlongStepFactory</span><span class="w"> </span><span class="k">final</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">celeritas</span><span class="o">::</span><span class="n">AlongStepFactoryInterface</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Emit the along-step action</span>
<span class="w">    </span><span class="n">result_type</span><span class="w"> </span><span class="k">operator</span><span class="p">()(</span><span class="n">argument_type</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NoFieldAlongStepFactory.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;type_traits&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;celeritas/global/alongstep/AlongStepGeneralLinearAction.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;celeritas/io/ImportData.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Emit the along-step action.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">auto</span><span class="w"> </span><span class="n">NoFieldAlongStepFactory</span><span class="o">::</span><span class="k">operator</span><span class="p">()(</span><span class="n">argument_type</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"></span>
<span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">result_type</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Create along-step action</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">celeritas</span><span class="o">::</span><span class="n">AlongStepGeneralLinearAction</span><span class="o">::</span><span class="n">from_params</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">input</span><span class="p">.</span><span class="n">action_id</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">input</span><span class="p">.</span><span class="n">material</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">input</span><span class="p">.</span><span class="n">particle</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="n">input</span><span class="p">.</span><span class="n">physics</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">input</span><span class="p">.</span><span class="n">imported</span><span class="o">-&gt;</span><span class="n">em_params</span><span class="p">.</span><span class="n">energy_loss_fluct</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
</section>
<section id="user-actions">
<h2>User actions<a class="headerlink" href="#user-actions" title="Permalink to this heading"></a></h2>
<p>The user actions are responsible for setting up Celeritas (using the
Acceleritas interface) and passing tracks to be offloaded.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4VUserPrimaryGeneratorAction.hh&gt;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Generate events by reading from a HepMC3 file.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">PrimaryGeneratorAction</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">G4VUserPrimaryGeneratorAction</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Get the total number of events available in the HepMC3 file</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">NumEvents</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Construct primary action</span>
<span class="w">    </span><span class="n">PrimaryGeneratorAction</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">default</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Generate events</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">GeneratePrimaries</span><span class="p">(</span><span class="n">G4Event</span><span class="o">*</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4UserRunAction.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/LocalTransporter.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/SetupOptions.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/SharedParams.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Set up and tear down Celeritas.</span>
<span class="cm"> *</span>
<span class="cm"> * Each Geant4 thread creates an instance of this class. In multithreaded mode,</span>
<span class="cm"> * the &quot;master&quot; instance does not have a local transporter and is responsible</span>
<span class="cm"> * for initializing the \c celeritas::SharedParams which is shared across all</span>
<span class="cm"> * threads/tasks. Worker threads are given a thread-local \c</span>
<span class="cm"> * celeritas::LocalTransporter which allocates Celeritas track state data at</span>
<span class="cm"> * the beginning of the run and clears it at the end.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">RunAction</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">G4UserRunAction</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@{</span>
<span class="w">    </span><span class="c1">//! \name Type aliases</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SPConstOptions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">celeritas</span><span class="o">::</span><span class="n">SetupOptions</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SPParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">celeritas</span><span class="o">::</span><span class="n">SharedParams</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SPTransporter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">celeritas</span><span class="o">::</span><span class="n">LocalTransporter</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@}</span>

<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">RunAction</span><span class="p">(</span><span class="n">SPConstOptions</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">SPParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">SPTransporter</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="kt">bool</span><span class="w"> </span><span class="n">init_celeritas</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">BeginOfRunAction</span><span class="p">(</span><span class="n">G4Run</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">run</span><span class="p">)</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">EndOfRunAction</span><span class="p">(</span><span class="n">G4Run</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">run</span><span class="p">)</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">SPConstOptions</span><span class="w"> </span><span class="n">options_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SPParams</span><span class="w"> </span><span class="n">params_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SPTransporter</span><span class="w"> </span><span class="n">transport_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">init_celeritas_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;RunAction.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;functional&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;type_traits&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;utility&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;celeritas_config.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/Assert.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/Macros.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/io/Logger.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/ExceptionConverter.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;GlobalSetup.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;NoFieldAlongStepFactory.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Construct with Celeritas setup options and shared data.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="n">RunAction</span><span class="o">::</span><span class="n">RunAction</span><span class="p">(</span><span class="n">SPConstOptions</span><span class="w"> </span><span class="n">options</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">SPParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="n">SPTransporter</span><span class="w"> </span><span class="n">transport</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="kt">bool</span><span class="w"> </span><span class="n">init_celeritas</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">options_</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">options</span><span class="p">)}</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">params_</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">params</span><span class="p">)}</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">transport_</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">transport</span><span class="p">)}</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">init_celeritas_</span><span class="p">{</span><span class="n">init_celeritas</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_EXPECT</span><span class="p">(</span><span class="n">options_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_EXPECT</span><span class="p">(</span><span class="n">params_</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Initialize Celeritas.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">RunAction</span><span class="o">::</span><span class="n">BeginOfRunAction</span><span class="p">(</span><span class="n">G4Run</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">run</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_EXPECT</span><span class="p">(</span><span class="n">run</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">celeritas</span><span class="o">::</span><span class="n">ExceptionConverter</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">{</span><span class="s">&quot;celer0001&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">init_celeritas_</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// This worker (or master thread) is responsible for initializing</span>
<span class="w">        </span><span class="c1">// celeritas</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">CELERITAS_USE_VECGEOM</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="c1">// For testing purposes, pass the GDML input filename to Celeritas</span>
<span class="w">            </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">celeritas</span><span class="o">::</span><span class="n">SetupOptions</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">options_</span><span class="p">).</span><span class="n">geometry_file</span><span class="w"></span>
<span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="n">GlobalSetup</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetGeometryFile</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Create the along-step action</span>
<span class="w">        </span><span class="n">GlobalSetup</span><span class="o">::</span><span class="n">Instance</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">SetAlongStep</span><span class="p">(</span><span class="n">NoFieldAlongStepFactory</span><span class="p">{});</span><span class="w"></span>

<span class="w">        </span><span class="c1">// Initialize shared data and setup GPU on all threads</span>
<span class="w">        </span><span class="n">CELER_TRY_HANDLE</span><span class="p">(</span><span class="n">params_</span><span class="o">-&gt;</span><span class="n">Initialize</span><span class="p">(</span><span class="o">*</span><span class="n">options_</span><span class="p">),</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">CELER_ASSERT</span><span class="p">(</span><span class="o">*</span><span class="n">params_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">else</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">CELER_TRY_HANDLE</span><span class="p">(</span><span class="n">celeritas</span><span class="o">::</span><span class="n">SharedParams</span><span class="o">::</span><span class="n">InitializeWorker</span><span class="p">(</span><span class="o">*</span><span class="n">options_</span><span class="p">),</span><span class="w"></span>
<span class="w">                         </span><span class="n">call_g4exception</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">transport_</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Allocate data in shared thread-local transporter</span>
<span class="w">        </span><span class="n">CELER_TRY_HANDLE</span><span class="p">(</span><span class="n">transport_</span><span class="o">-&gt;</span><span class="n">Initialize</span><span class="p">(</span><span class="o">*</span><span class="n">options_</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">params_</span><span class="p">),</span><span class="w"></span>
<span class="w">                         </span><span class="n">call_g4exception</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">CELER_ENSURE</span><span class="p">(</span><span class="o">*</span><span class="n">transport_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Finalize Celeritas.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">RunAction</span><span class="o">::</span><span class="n">EndOfRunAction</span><span class="p">(</span><span class="n">G4Run</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_LOG_LOCAL</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Finalizing Celeritas&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">celeritas</span><span class="o">::</span><span class="n">ExceptionConverter</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">{</span><span class="s">&quot;celer0005&quot;</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">transport_</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Deallocate Celeritas state data (ensures that objects are deleted on</span>
<span class="w">        </span><span class="c1">// the thread in which they&#39;re created, necessary by some geant4</span>
<span class="w">        </span><span class="c1">// thread-local allocators)</span>
<span class="w">        </span><span class="n">CELER_TRY_HANDLE</span><span class="p">(</span><span class="n">transport_</span><span class="o">-&gt;</span><span class="n">Finalize</span><span class="p">(),</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">init_celeritas_</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Clear shared data and write</span>
<span class="w">        </span><span class="n">CELER_TRY_HANDLE</span><span class="p">(</span><span class="n">params_</span><span class="o">-&gt;</span><span class="n">Finalize</span><span class="p">(),</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4UserEventAction.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/LocalTransporter.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Manage begin- and end-of-event setup.</span>
<span class="cm"> *</span>
<span class="cm"> * This class is local to a thread/task/stream, but it shares \c</span>
<span class="cm"> * LocalTransporter with other user actions on the current thread.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">EventAction</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">G4UserEventAction</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@{</span>
<span class="w">    </span><span class="c1">//! \name Type aliases</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SPTransporter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">celeritas</span><span class="o">::</span><span class="n">LocalTransporter</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@}</span>

<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">EventAction</span><span class="p">(</span><span class="n">SPTransporter</span><span class="w"> </span><span class="n">transport</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">BeginOfEventAction</span><span class="p">(</span><span class="n">G4Event</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">EndOfEventAction</span><span class="p">(</span><span class="n">G4Event</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">SPTransporter</span><span class="w"> </span><span class="n">transport_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;EventAction.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;type_traits&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4Event.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/Macros.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/ExceptionConverter.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Construct with thread-local Celeritas data.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="n">EventAction</span><span class="o">::</span><span class="n">EventAction</span><span class="p">(</span><span class="n">SPTransporter</span><span class="w"> </span><span class="n">transport</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">transport_</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Inform Celeritas of the new event&#39;s ID.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">EventAction</span><span class="o">::</span><span class="n">BeginOfEventAction</span><span class="p">(</span><span class="n">G4Event</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Set event ID in local transporter</span>
<span class="w">    </span><span class="n">celeritas</span><span class="o">::</span><span class="n">ExceptionConverter</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">{</span><span class="s">&quot;celer0002&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_TRY_HANDLE</span><span class="p">(</span><span class="n">transport_</span><span class="o">-&gt;</span><span class="n">SetEventId</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">GetEventID</span><span class="p">()),</span><span class="w"></span>
<span class="w">                     </span><span class="n">call_g4exception</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Flush all offloaded tracks before ending the event.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">EventAction</span><span class="o">::</span><span class="n">EndOfEventAction</span><span class="p">(</span><span class="n">G4Event</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Transport any tracks left in the buffer</span>
<span class="w">    </span><span class="n">celeritas</span><span class="o">::</span><span class="n">ExceptionConverter</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">{</span><span class="s">&quot;celer0004&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_TRY_HANDLE</span><span class="p">(</span><span class="n">transport_</span><span class="o">-&gt;</span><span class="n">Flush</span><span class="p">(),</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4UserTrackingAction.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/LocalTransporter.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/SharedParams.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Offload EM tracks to Celeritas.</span>
<span class="cm"> *</span>
<span class="cm"> * This class is local to a thread/task/stream. It shares \c SharedParams with</span>
<span class="cm"> * all threads/tasks, and it shares \c LocalTransporter with other user actions</span>
<span class="cm"> * on the current thread.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">TrackingAction</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">G4UserTrackingAction</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@{</span>
<span class="w">    </span><span class="c1">//! \name Type aliases</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SPConstParams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">celeritas</span><span class="o">::</span><span class="n">SharedParams</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SPTransporter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">celeritas</span><span class="o">::</span><span class="n">LocalTransporter</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@}</span>

<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">TrackingAction</span><span class="p">(</span><span class="n">SPConstParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">SPTransporter</span><span class="w"> </span><span class="n">transport</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">PreUserTrackingAction</span><span class="p">(</span><span class="n">G4Track</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">track</span><span class="p">)</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="n">SPConstParams</span><span class="w"> </span><span class="n">params_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SPTransporter</span><span class="w"> </span><span class="n">transport_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;TrackingAction.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iterator&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;type_traits&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4Electron.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4Gamma.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4ParticleDefinition.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4Positron.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4Track.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4TrackStatus.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/Assert.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/Macros.hh&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;accel/ExceptionConverter.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Construct with Celeritas shared and thread-local data.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="n">TrackingAction</span><span class="o">::</span><span class="n">TrackingAction</span><span class="p">(</span><span class="n">SPConstParams</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">SPTransporter</span><span class="w"> </span><span class="n">transport</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">params_</span><span class="p">(</span><span class="n">params</span><span class="p">),</span><span class="w"> </span><span class="n">transport_</span><span class="p">(</span><span class="n">transport</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_EXPECT</span><span class="p">(</span><span class="n">params_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_EXPECT</span><span class="p">(</span><span class="n">transport_</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * At the start of a track, determine whether to use Celeritas to transport it.</span>
<span class="cm"> *</span>
<span class="cm"> * If the track is one of a few predetermined EM particles, we pass it to</span>
<span class="cm"> * Celeritas (which queues the track on its buffer and potentially flushes it)</span>
<span class="cm"> * and kill the Geant4 track.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">TrackingAction</span><span class="o">::</span><span class="n">PreUserTrackingAction</span><span class="p">(</span><span class="n">G4Track</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="n">track</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_EXPECT</span><span class="p">(</span><span class="n">track</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_EXPECT</span><span class="p">(</span><span class="o">*</span><span class="n">params_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_EXPECT</span><span class="p">(</span><span class="o">*</span><span class="n">transport_</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">G4ParticleDefinition</span><span class="w"> </span><span class="k">const</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">allowed_particles</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">G4Gamma</span><span class="o">::</span><span class="n">Gamma</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">G4Electron</span><span class="o">::</span><span class="n">Electron</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">G4Positron</span><span class="o">::</span><span class="n">Positron</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">allowed_particles</span><span class="p">),</span><span class="w"></span>
<span class="w">                  </span><span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">allowed_particles</span><span class="p">),</span><span class="w"></span>
<span class="w">                  </span><span class="n">track</span><span class="o">-&gt;</span><span class="n">GetDefinition</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="o">!=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">allowed_particles</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Celeritas is transporting this track</span>
<span class="w">        </span><span class="n">celeritas</span><span class="o">::</span><span class="n">ExceptionConverter</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">{</span><span class="s">&quot;celer0003&quot;</span><span class="p">};</span><span class="w"></span>
<span class="w">        </span><span class="n">CELER_TRY_HANDLE</span><span class="p">(</span><span class="n">transport_</span><span class="o">-&gt;</span><span class="n">Push</span><span class="p">(</span><span class="o">*</span><span class="n">track</span><span class="p">),</span><span class="w"> </span><span class="n">call_g4exception</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">const_cast</span><span class="o">&lt;</span><span class="n">G4Track</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">track</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">SetTrackStatus</span><span class="p">(</span><span class="n">fStopAndKill</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
</section>
<section id="sensitive-detectors">
<h2>Sensitive Detectors<a class="headerlink" href="#sensitive-detectors" title="Permalink to this heading"></a></h2>
<p>The SD setup options in the <code class="docutils literal notranslate"><span class="pre">DetectorConstruction</span></code> constructor should be set
as the union of requirements over all user Geant4 sensitive detectors.  The
sensitive detector here is pretty generic and requires only the touchable, the
energy deposition, and the time.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4THitsCollection.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4VSensitiveDetector.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SensitiveHit.hh&quot;</span><span class="cp"></span>

<span class="k">class</span><span class="w"> </span><span class="nc">G4Step</span><span class="p">;</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">G4HCofThisEvent</span><span class="p">;</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">G4TouchableHistory</span><span class="p">;</span><span class="w"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Example sensitive detector.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">SensitiveDetector</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">G4VSensitiveDetector</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@{</span>
<span class="w">    </span><span class="c1">//! \name Type aliases</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">SensitiveHitsCollection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G4THitsCollection</span><span class="o">&lt;</span><span class="n">SensitiveHit</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">//!@}</span>

<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">SensitiveDetector</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">protected</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Initialize</span><span class="p">(</span><span class="n">G4HCofThisEvent</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ProcessHits</span><span class="p">(</span><span class="n">G4Step</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">G4TouchableHistory</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">final</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">hcid_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">SensitiveHitsCollection</span><span class="o">*</span><span class="w"> </span><span class="n">collection_</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;SensitiveDetector.hh&quot;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4HCofThisEvent.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4SDManager.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4Step.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4StepPoint.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4String.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4VPhysicalVolume.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4VTouchable.hh&gt;</span><span class="cp"></span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;corecel/Assert.hh&quot;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="n">SensitiveDetector</span><span class="o">::</span><span class="n">SensitiveDetector</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">G4VSensitiveDetector</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="w"> </span><span class="n">hcid_</span><span class="p">{</span><span class="mi">-1</span><span class="p">},</span><span class="w"> </span><span class="n">collection_</span><span class="p">{</span><span class="k">nullptr</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">collectionName</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_HC&quot;</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Set up hit collections for a new event.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">void</span><span class="w"> </span><span class="n">SensitiveDetector</span><span class="o">::</span><span class="n">Initialize</span><span class="p">(</span><span class="n">G4HCofThisEvent</span><span class="o">*</span><span class="w"> </span><span class="n">hce</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">SensitiveHitsCollection</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">SensitiveDetectorName</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">collectionName</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hcid_</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Initialize during the first event. The SD collection was registered</span>
<span class="w">        </span><span class="c1">// inside DetectorConstruction::ConstructSDandField on the local</span>
<span class="w">        </span><span class="c1">// thread.</span>
<span class="w">        </span><span class="n">hcid_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G4SDManager</span><span class="o">::</span><span class="n">GetSDMpointer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCollectionID</span><span class="p">(</span><span class="n">collection</span><span class="p">.</span><span class="n">get</span><span class="p">());</span><span class="w"></span>
<span class="w">        </span><span class="n">CELER_ASSERT</span><span class="p">(</span><span class="n">hcid_</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Save a pointer to the collection we just made before tranferring</span>
<span class="w">    </span><span class="c1">// ownership to the HC manager for the event.</span>
<span class="w">    </span><span class="n">collection_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">collection</span><span class="p">.</span><span class="n">get</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">hce</span><span class="o">-&gt;</span><span class="n">AddHitsCollection</span><span class="p">(</span><span class="n">hcid_</span><span class="p">,</span><span class="w"> </span><span class="n">collection</span><span class="p">.</span><span class="n">release</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_ENSURE</span><span class="p">(</span><span class="n">collection_</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Add hits to the current hit collection.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kt">bool</span><span class="w"> </span><span class="n">SensitiveDetector</span><span class="o">::</span><span class="n">ProcessHits</span><span class="p">(</span><span class="n">G4Step</span><span class="o">*</span><span class="w"> </span><span class="n">step</span><span class="p">,</span><span class="w"> </span><span class="n">G4TouchableHistory</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">edep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">step</span><span class="o">-&gt;</span><span class="n">GetTotalEnergyDeposit</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">edep</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Create a hit for this step</span>
<span class="w">    </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">touchable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">step</span><span class="o">-&gt;</span><span class="n">GetPreStepPoint</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTouchable</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">CELER_ASSERT</span><span class="p">(</span><span class="n">touchable</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">touchable</span><span class="o">-&gt;</span><span class="n">GetVolume</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCopyNo</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">HitData</span><span class="w"> </span><span class="n">data</span><span class="p">{</span><span class="n">id</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">edep</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="n">step</span><span class="o">-&gt;</span><span class="n">GetPreStepPoint</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetGlobalTime</span><span class="p">(),</span><span class="w"></span>
<span class="w">                 </span><span class="n">touchable</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">()};</span><span class="w"></span>

<span class="w">    </span><span class="n">collection_</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SensitiveHit</span><span class="p">(</span><span class="n">data</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4Allocator.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4ThreeVector.hh&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;G4VHit.hh&gt;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">demo_geant</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Example sensitive hit data.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">struct</span><span class="w"> </span><span class="nc">HitData</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w">  </span><span class="c1">//!&lt; detector id</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">edep</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w">  </span><span class="c1">//!&lt; energy deposition</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">time</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w">  </span><span class="c1">//!&lt; time (global coordinate)</span>
<span class="w">    </span><span class="n">G4ThreeVector</span><span class="w"> </span><span class="n">pos</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">};</span><span class="w">  </span><span class="c1">//!&lt; position (global coordinate)</span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Example sensitive hit class.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">SensitiveHit</span><span class="w"> </span><span class="k">final</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">G4VHit</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">explicit</span><span class="w"> </span><span class="n">SensitiveHit</span><span class="p">(</span><span class="n">HitData</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">//! Accessor the hit data</span>
<span class="w">    </span><span class="n">HitData</span><span class="w"> </span><span class="k">const</span><span class="o">&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">data_</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Overload new/delete to use a custom allocator.</span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="k">operator</span><span class="w"> </span><span class="k">delete</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span><span class="w"></span>

<span class="w">  </span><span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">HitAllocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G4Allocator</span><span class="o">&lt;</span><span class="n">SensitiveHit</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">HitData</span><span class="w"> </span><span class="n">data_</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">HitAllocator</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">allocator</span><span class="p">();</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="c1">// INLINE DEFINITIONS</span>
<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Use G4Allocator to allocate memory for a SensitiveHit.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">SensitiveHit</span><span class="o">::</span><span class="k">operator</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SensitiveHit</span><span class="o">::</span><span class="n">allocator</span><span class="p">().</span><span class="n">MallocSingle</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="cm">/*!</span>
<span class="cm"> * Use G4Allocator to release memory for a SensitiveHit.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">SensitiveHit</span><span class="o">::</span><span class="k">operator</span><span class="w"> </span><span class="k">delete</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">hit</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">SensitiveHit</span><span class="o">::</span><span class="n">allocator</span><span class="p">().</span><span class="n">FreeSingle</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">SensitiveHit</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">hit</span><span class="p">));</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">//---------------------------------------------------------------------------//</span>
<span class="p">}</span><span class="w">  </span><span class="c1">// namespace demo_geant</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="geant4-minimal.html" class="btn btn-neutral float-left" title="Minimal Geant4 integration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../references.html" class="btn btn-neutral float-right" title="References" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, UT–Battelle/ORNL and Celeritas team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>